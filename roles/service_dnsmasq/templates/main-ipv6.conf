## WIP!! playground

# {{ ansible_managed }}
# here are the leases: /var/lib/misc/dnsmasq.leases

# Listen on this standard DNS port
port=53

dhcp-authoritative # authoritative DHCP mode

domain={{ service_dnsmasq_domain_name }}

{% if service_dnsmasq_interface is defined -%}
interface={{ service_dnsmasq_interface }} # Interface name could be wired or wireless
{% endif %}
{% if service_dnsmasq_listen_address is defined -%}
listen-address={{ service_dnsmasq_listen_address }} # address to listen on
{% endif %}

# Upstream DNS servers
{% if service_dnsmasq_upstream_dns is defined -%}
{% if service_dnsmasq_upstream_dns is string -%}
server={{ service_dnsmasq_upstream_dns }}
{% else %}
{% for nameserver in service_dnsmasq_upstream_dns -%}
server={{ nameserver }}
{% endfor %}
{% endif %}
{% endif %}

# Force the upstream servers to be used in order
strict-order

# Increase the cachesize
cache-size=1500

## ipv4
dhcp-option=option:router,{{ service_dnsmasq_dhcp_gateway4 }}
dhcp-option=option:netmask,{{ service_dnsmasq_dhcp_netmask4 }}
# send to the clients our dnsmasq as dns
dhcp-option=option:dns-server,{{ service_dnsmasq_server_ip4 }}
#multiple servers dhcp
#dhcp-option=option:dns-server,{{ service_dnsmasq_upstream_dns }},8.8.8.8
#dhcp-option=option:dns-server,{{ service_dnsmasq_upstream_dns }}

## ipv6 section
enable-ra # Enable router advertisement

# IPv4 range and lease time
dhcp-range={{ service_dnsmasq_dhcp_range4_start }},{{ service_dnsmasq_dhcp_range4_end }},{{ service_dnsmasq_dhcp_lease_time }}

# IPv6 range and lease time
dhcp-range={{ service_dnsmasq_dhcp_range6_start }},{{ service_dnsmasq_dhcp_range6_end }},{{ service_dnsmasq_dhcp_lease_time }}

# Never forward plain names (without a dot or domain part)
domain-needed

# Never forward addresses in the non-routed address spaces.
# bogus-priv

{% if service_dnsmasq_static_host_entries is defined -%}
# static host entries via /etc/hosts
local=/{{ service_dnsmasq_domain_name }}/
{% else %}
# Don't read /etc/hosts file
no-hosts
{% endif %}


# Don't read /etc/resolv.conf or any other file.
# Use only the configuration provided by this file.
no-resolv

# Don't poll changes from external files (like /etc/resolv.conf)
no-poll

# Don't store in cache the invalid resolutions
no-negcache

{% if service_dnsmasq_dhcp_range_cluster is defined -%}
## Tag based Ranges

{% for cluster in service_dnsmasq_dhcp_range_cluster -%}
dhcp-host={{ cluster.mac_prefix }}:*:*:*,set:{{ cluster.tag }}
{% if cluster.ip4_prefix is defined -%}
# IPv4 range and lease time
dhcp-range=tag:{{ cluster.tag }},{{ cluster.ip4_prefix }}.{{ service_dnsmasq_dhcp_range_cluster_ip4_start_postfix }},{{ cluster.ip4_prefix }}.{{ service_dnsmasq_dhcp_range_cluster_ip4_end_postfix }},{{ service_dnsmasq_dhcp_lease_time }}
{% endif %}
{% if cluster.ip6_prefix is defined -%}
# IPv6 range and lease time
dhcp-range=tag:{{ cluster.tag }},{{ cluster.ip6_prefix }}::{{ service_dnsmasq_dhcp_range_cluster_ip6_start_postfix }},{{ cluster.ip6_prefix }}::{{ service_dnsmasq_dhcp_range_cluster_ip6_end_postfix }},{{ service_dnsmasq_dhcp_lease_time }}

{% endif %}
{% endfor %}
{% endif %}


{% if false -%}
######################################################################
# nice idea on how to use tags for everything based in the mac
# dhcp-range=tag:red,10.101.90.100,10.101.90.150,{{ service_dnsmasq_dhcp_lease_time }} # IPv4 range and lease time
# dhcp-range=tag:red,fd3c:ba45:c3ea:26e5:cafe::02,fd3c:ba45:c3ea:26e5:cafe::ff,{{ service_dnsmasq_dhcp_lease_time }} # IPv6 range and lease time
# # https://en.wikipedia.org/wiki/MAC_address#Unicast_vs._multicast_(I/G_bit)
# # "X4-XX-XX-XX-XX"
# dhcp-host=14:22:33:*:*:*,set:red
{% endif %}

{% if service_dnsmasq_address is defined -%}
# wildcard subdomain
{% for address in service_dnsmasq_address -%}
address={{ address }}
{% endfor %}
{% endif %}

######################################################################
# Fake domain to test the configuration
# address=/testdomain.tld/1.2.3.4

#log-facility=/var/log/dnsmasq.log
#log-async
#log-queries
#log-dhcp
